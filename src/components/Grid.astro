---
import Button from './shared/Button.astro';
import en from '../i18n/messages/en.json';
import es from '../i18n/messages/es.json';

const lang = Astro.url.pathname.includes('/es') ? 'es' : 'en';
const t = lang === 'es' ? es : en;
const base = lang === 'es' ? '/es' : '';

// Offsets muy dispersos: inicio, mitad, final, mezclados
const videoOffsets = [0, 45, 15, 60, 30, 75, 10, 55, 40];
---

<section class="bg-ivory py-20 md:py-32">
    <div class="max-w-screen-xl mx-auto px-6 md:px-12">
        <div id="video-grid" data-aos="fade-up" class="grid grid-cols-1 md:grid-cols-3 gap-3 md:gap-4">
            {videoOffsets.map((offset, index) => (
                <div class={`overflow-hidden ${index >= 4 ? 'hidden md:block' : ''}`}>
                    <video 
                        muted 
                        loop 
                        playsinline
                        preload="none"
                        data-src="/assets/videos/hero.mp4"
                        data-offset={offset}
                        class="lazy-video grid-video h-auto w-full object-cover pointer-events-none hover:scale-105 transition-transform duration-700"
                    >
                    </video>
                </div>
            ))}
        </div>

        <div class="text-center mt-12 md:mt-16">
            <Button href={`${base}/gallery`} label={t.grid.cta} variant="primary" />
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const lazyVideos = document.querySelectorAll('.lazy-video') as NodeListOf<HTMLVideoElement>;
        
        const videoObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const video = entry.target as HTMLVideoElement;
                    const src = video.dataset.src;
                    const offset = parseInt(video.dataset.offset || '0', 10);
                    
                    if (src && !video.src) {
                        // Crear source y cargar video
                        const source = document.createElement('source');
                        source.src = src;
                        source.type = 'video/mp4';
                        video.appendChild(source);
                        video.load();
                        
                        // Cuando cargue, aplicar offset y reproducir
                        video.addEventListener('loadedmetadata', () => {
                            if (video.duration) {
                                video.currentTime = offset % video.duration;
                            }
                            video.play().catch(() => {});
                        });
                    }
                    
                    videoObserver.unobserve(video);
                }
            });
        }, {
            rootMargin: '100px 0px',
            threshold: 0.1
        });
        
        lazyVideos.forEach(video => videoObserver.observe(video));
    });
</script>
